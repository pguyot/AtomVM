#
#  Copyright 2022 Davide Bettio <davide@uninstall.it>
#
#  SPDX-License-Identifier: Apache-2.0 OR LGPL-2.1-or-later
#

name: Build and Test on Other Architectures

on:
  push:
    paths-ignore:
      - 'src/platforms/emscripten/**'
      - 'src/platforms/esp32/**'
      - 'src/platforms/rp2/**'
      - 'src/platforms/stm32/**'
      - 'doc/**'
      - 'LICENSES/**'
      - '*.Md'
      - '*.md'
  pull_request:
    paths-ignore:
      - 'src/platforms/emscripten/**'
      - 'src/platforms/esp32/**'
      - 'src/platforms/rp2/**'
      - 'src/platforms/stm32/**'
      - 'doc/**'
      - 'LICENSES/**'
      - '*.Md'
      - '*.md'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref != 'refs/heads/main' && github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  compile_jit_and_tests:
    runs-on: ubuntu-24.04
    container: erlang:27
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Install required packages
      run: apt update && apt install -y gperf zlib1g-dev cmake ninja-build

    - name: Compile jit and test modules
      run: |
        set -e
        mkdir build_tests
        cd build_tests
        cmake .. -G Ninja -DAVM_WARNINGS_ARE_ERRORS=ON
        ninja jit jit_x86_64 jit_aarch64 jit_armv6m erlang_test_modules test_etest test_estdlib test_eavmlib test_alisp
        # jit_precompile tests
        find tests/erlang_tests
        mkdir -p tests/erlang_tests/armv6m/
        erl -pa libs/jit/src/beams/ -noshell -s jit_precompile -s init stop -- armv6m tests/erlang_tests/armv6m/ tests/erlang_tests/*.beam
        mkdir -p tests/erlang_tests/code_load/beams/armv6m/
        erl -pa libs/jit/src/beams/ -noshell -s jit_precompile -s init stop -- armv6m tests/erlang_tests/code_load/beams/armv6m/ tests/erlang_tests/code_load/beams/*.beam


    - name: Upload jit and test modules
      uses: actions/upload-artifact@v4
      with:
        name: jit-and-test-modules
        path: |
            build_tests/**/*.avm
            build_tests/**/*.beam
            build_tests/**/*.hrl
        retention-days: 1


  build-and-test-other:
    needs: [compile_jit_and_tests]
    # GCC on qemu segfaults on s390x and arm64v8 when using 24.04
    # See also https://github.com/actions/runner-images/issues/11471
    runs-on: ubuntu-22.04

    strategy:
      fail-fast: false
      matrix:
        include:
        - arch: "arm32v5"
          platform: "arm/v5"
          debian_version: "stretch"
          docker_tag: "arm32v5-debian-stretch-buildtools"
          cflags: "-O2 -mthumb -mthumb-interwork -march=armv4t"
          cmake_opts: "-DAVM_DISABLE_SMP=On -DAVM_DISABLE_TASK_DRIVER=On"
          dockerfile: |
            FROM arm32v5/debian:stretch
            RUN echo "deb [trusted=yes] http://archive.debian.org/debian/ stretch-backports main" > /etc/apt/sources.list && \
                echo "deb [trusted=yes] http://archive.debian.org/debian/ stretch-backports-sloppy main" >> /etc/apt/sources.list && \
                echo "deb [trusted=yes] http://archive.debian.org/debian-security/ stretch/updates main" >> /etc/apt/sources.list && \
                echo "deb-src [trusted=yes] http://archive.debian.org/debian-security/ stretch/updates main" >> /etc/apt/sources.list && \
                echo "deb [trusted=yes] http://archive.debian.org/debian/ stretch main" >> /etc/apt/sources.list && \
                echo "deb-src [trusted=yes] http://archive.debian.org/debian/ stretch main" >> /etc/apt/sources.list
            RUN apt update && \
                apt install -y -t stretch-backports-sloppy libarchive13 && \
                apt install -y -t stretch-backports cmake && \
                apt install -y file gcc g++ binutils make doxygen gperf zlib1g-dev libmbedtls-dev
            WORKDIR /atomvm

        - arch: "arm32v7"
          platform: "arm/v7"
          debian_version: "bookworm"
          docker_tag: "arm32v7-debian-bookworm-buildtools"
          # -D_FILE_OFFSET_BITS=64 is required for making atomvm:posix_readdir/1 test work
          # otherwise readdir will fail due to 64 bits inode numbers with 32 bit ino_t
          cflags: "-mcpu=cortex-a7 -mfloat-abi=hard -O2 -mthumb -mthumb-interwork -D_FILE_OFFSET_BITS=64"
          cmake_opts: "-DAVM_WARNINGS_ARE_ERRORS=ON"
          dockerfile: |
            FROM arm32v7/debian:bookworm
            RUN apt update && \
                apt install -y file gcc g++ binutils cmake make doxygen gperf zlib1g-dev libmbedtls-dev
            WORKDIR /atomvm

        - arch: "arm32v7"
          platform: "arm/v7"
          debian_version: "trixie"
          docker_tag: "arm32v7-debian-trixie-buildtools"
          # -D_FILE_OFFSET_BITS=64 is required for making atomvm:posix_readdir/1 test work
          # otherwise readdir will fail due to 64 bits inode numbers with 32 bit ino_t
          cflags: "-mcpu=cortex-a7 -mfloat-abi=hard -O2 -mthumb -mthumb-interwork -D_FILE_OFFSET_BITS=64"
          cmake_opts: "-DAVM_WARNINGS_ARE_ERRORS=ON -DAVM_DISABLE_JIT=OFF"
          dockerfile: |
            FROM arm32v7/debian:trixie
            RUN apt update && \
                apt install -y file gcc g++ binutils cmake make doxygen gperf zlib1g-dev libmbedtls-dev erlang
            WORKDIR /atomvm

        - arch: "arm64v8"
          platform: "arm64/v8"
          debian_version: "bookworm"
          docker_tag: "arm64v8-debian-bookworm-buildtools"
          cflags: "-O2"
          cmake_opts: "-DAVM_WARNINGS_ARE_ERRORS=ON"
          dockerfile: |
            FROM arm64v8/debian:bookworm
            RUN apt update && \
                apt install -y file gcc g++ binutils cmake make doxygen gperf zlib1g-dev libmbedtls-dev
            WORKDIR /atomvm

        # Required for testing big endian archs
        - arch: "s390x"
          platform: "s390x"
          debian_version: "bookworm"
          docker_tag: "s390x-debian-bookworm-buildtools"
          cflags: "-O2"
          cmake_opts: "-DAVM_WARNINGS_ARE_ERRORS=ON"
          dockerfile: |
            FROM s390x/debian:bookworm
            RUN apt update && \
                apt install -y file gcc g++ binutils cmake make doxygen gperf zlib1g-dev libmbedtls-dev
            WORKDIR /atomvm

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: apt update
      run: sudo apt update

    - name: Install required packages
      run: sudo apt install -y debootstrap

    - name: Download test modules
      uses: actions/download-artifact@v4
      with:
        name: jit-and-test-modules
        path: build_tests

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and load cached environment
      run: |
        echo '${{ matrix.dockerfile }}' > Dockerfile.build

    - name: Build Docker image with cache
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.build
        platforms: linux/${{ matrix.platform }}
        tags: atomvm-build-${{ matrix.docker_tag }}:latest
        cache-from: type=gha,scope=${{ matrix.docker_tag }}
        cache-to: type=gha,mode=max,scope=${{ matrix.docker_tag }}
        load: true

    - name: "Build and Test: AtomVM on foreign arch"
      timeout-minutes: 45
      run: |
        docker run --platform linux/${{ matrix.platform }} --rm -v $PWD:/atomvm -w /atomvm \
        -e CFLAGS="${{ matrix.cflags }}" -e CXXFLAGS="${{ matrix.cflags }}" \
        atomvm-build-${{ matrix.docker_tag }}:latest /bin/bash -c '
        file /bin/bash &&
        uname -a &&
        cc --version &&
        ld --version &&
        ldd --version &&
        echo $CFLAGS &&
        echo $CXXFLAGS &&
        cmake --version &&
        mkdir -p build &&
        cd build &&
        cmake .. ${{ matrix.cmake_opts }} &&
        make PackBEAM &&
        cp ../build_tests/tests/erlang_tests/*.beam tests/erlang_tests/ &&
        cp ../build_tests/tests/erlang_tests/code_load/*.{avm,beam,hrl} tests/erlang_tests/code_load/ &&
        mkdir -p tests/erlang_tests/code_load/beams/ &&
        cp ../build_tests/tests/erlang_tests/code_load/beams/*.beam tests/erlang_tests/code_load/beams/ &&
        cp ../build_tests/tests/libs/etest/*.avm tests/libs/etest/  &&
        cp ../build_tests/tests/libs/estdlib/*.avm tests/libs/estdlib/  &&
        cp ../build_tests/tests/libs/eavmlib/*.avm tests/libs/eavmlib/ &&
        cp ../build_tests/tests/libs/alisp/*.avm tests/libs/alisp/ &&
        cp ../build_tests/tests/libs/jit/*.avm tests/libs/jit/ &&
        cp -r ../build_tests/libs/* libs/ &&
        touch tests/erlang_tests/code_load/code_load_pack.avm &&
        touch tests/erlang_tests/code_load/code_load_pack_data.hrl &&
        echo "Touching JIT artifacts to prevent rebuilding:" &&
        find libs/jit/src -name "*.avm" -exec touch {} \; &&
        find libs/jit/src -name "*.beam" -exec touch {} \; &&
        echo "=== File timestamp diagnostics ===" &&
        (ls -la libs/jit/src/beams/*.beam 2>/dev/null | head -5 || echo "No JIT .beam files found") &&
        (ls -la tests/erlang_tests/code_load/beams/*.beam 2>/dev/null | head -5 || echo "No test .beam files found") &&
        (find . -name "*.erl" | head -5 | xargs ls -la 2>/dev/null || echo "No .erl source files found") &&
        echo "=== Make diagnostics ===" &&
        (command -v erlc && echo "erlc found" || echo "erlc not found") &&
        (command -v escript && echo "escript found" || echo "escript not found") &&
        echo "CMAKE_SYSTEM_PROCESSOR: $CMAKE_SYSTEM_PROCESSOR" &&
        echo "AVM_JIT_TARGET_ARCH from cmake cache:" &&
        (grep AVM_JIT_TARGET_ARCH CMakeCache.txt || echo "AVM_JIT_TARGET_ARCH not found in cache") &&
        echo "Make dry-run for test-erlang (first 15 lines):" &&
        (make -n test-erlang 2>&1 | head -15 || true) &&
        echo "Is test-erlang up to date?" &&
        (make -q test-erlang 2>&1 && echo "test-erlang is up to date" || echo "test-erlang needs rebuilding") &&
        echo "=== End diagnostics ===" &&
        cmake --build . --target AtomVM &&
        cmake --build . --target test-erlang &&
        cmake --build . --target test-enif &&
        cmake --build . --target test-heap &&
        cmake --build . --target test-mailbox &&
        cmake --build . --target test-structs &&
        file ./tests/test-erlang &&
        ./tests/test-erlang -s prime_smp &&
        file ./tests/test-enif &&
        ./tests/test-enif &&
        file ./tests/test-heap &&
        ./tests/test-heap &&
        file ./tests/test-mailbox &&
        ./tests/test-mailbox &&
        file ./tests/test-structs &&
        ./tests/test-structs &&
        file ./src/AtomVM &&
        ./src/AtomVM tests/libs/etest/test_etest.avm &&
        ./src/AtomVM tests/libs/estdlib/test_estdlib.avm &&
        ./src/AtomVM tests/libs/eavmlib/test_eavmlib.avm &&
        ./src/AtomVM tests/libs/alisp/test_alisp.avm
        '
